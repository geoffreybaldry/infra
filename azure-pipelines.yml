trigger:
  branches:
    #- main
    - next

pr:
  branches:
    - main
    - next

pool:
  name: Azure Pipelines

resources:
  repositories:
    - repository: build_templates
      type: github
      name: geoffreybaldry/build_templates
      endpoint: geoffreybaldry # The name of the github service connection
      #ref: refs/heads/next

variables:
- group: "terraform-pipeline-vg"
  readonly: true
- name: terraform.version
  value: "latest"
  readonly: true

stages:
  - stage: init_validate
    jobs:
      - job: terraform_validate
        steps:
          - template: init.yml@build_templates
            parameters:
              version: $(terraform.version)
          
          - task: ms-devlabs.custom-terraform-tasks.custom-terraform-release-task.TerraformTaskV2@2
            displayName: 'Terraform : validate'
            inputs:
              provider: aws
              command: validate
              backendServiceAWS: 'AWS for Terraform Service Connection'

      - job: terraform_plan
        steps:
          - template: init.yml@build_templates
            parameters:
              version: $(terraform.version)

          - task: ms-devlabs.custom-terraform-tasks.custom-terraform-release-task.TerraformTaskV2@2
            displayName: 'Terraform : plan'
            inputs:
              provider: aws
              command: plan
              environmentServiceNameAWS: 'AWS for Terraform Service Connection'
